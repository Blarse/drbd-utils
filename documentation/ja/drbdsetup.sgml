<!DOCTYPE RefEntry PUBLIC "-//Davenport//DTD DocBook V3.0//EN">
<refentry>
<docinfo><date>15 Apr 2001</date></docinfo>

<refmeta>
 <refentrytitle>drbdsetup</refentrytitle>
 <manvolnum>8</manvolnum>
</refmeta>

<refnamediv>
 <refname>drbdsetup</refname>
 <refpurpose>DRBD設定ツール</refpurpose>
</refnamediv>

<refsynopsisdiv>
 <cmdsynopsis>
  <command>drbdsetup</command>
  <arg choice=req><replaceable>device</replaceable></arg>
  <arg choice=req>disk</arg>
  <arg choice=req><replaceable>lower_device</replaceable></arg>
  <arg>-d<arg choice=req><replaceable>size</replaceable></arg></arg>
  <arg>-p</arg>
 </cmdsynopsis>
 <cmdsynopsis>
  <command>drbdsetup</command>
  <arg choice=req><replaceable>device</replaceable></arg>
  <arg choice=req>net</arg>
  <arg choice=req><replaceable>local_addr</replaceable></arg>
  <arg><replaceable>:port</replaceable></arg>
  <arg choice=req><replaceable>remote_addr</replaceable></arg>
  <arg><replaceable>:port</replaceable></arg>
  <arg choice=req><replaceable>protocol</replaceable></arg>
  <arg>-r<arg choice=req><replaceable>rate</replaceable></arg></arg>
  <arg>-s<arg choice=req><replaceable>size</replaceable></arg></arg>
  <arg>-c<arg choice=req><replaceable>time</replaceable></arg></arg>
  <arg>-i<arg choice=req><replaceable>time</replaceable></arg></arg>
  <arg>-k</arg>
 </cmdsynopsis>
 <cmdsynopsis>
  <command>drbdsetup</command>
  <arg choice=req><replaceable>device</replaceable></arg>
  <arg choice=req>disconnect</arg>
 </cmdsynopsis>
 <cmdsynopsis>
  <command>drbdsetup</command>
  <arg choice=req><replaceable>device</replaceable></arg>
  <arg choice=req>down</arg>
 </cmdsynopsis>
 <cmdsynopsis>
  <command>drbdsetup</command>
  <arg choice=req><replaceable>device</replaceable></arg>
  <arg choice=req>primary</arg>
 </cmdsynopsis>
 <cmdsynopsis>
  <command>drbdsetup</command>
  <arg choice=req><replaceable>device</replaceable></arg>
  <arg choice=req>secondary</arg>
 </cmdsynopsis>
 <cmdsynopsis>
  <command>drbdsetup</command>
  <arg choice=req><replaceable>device</replaceable></arg>
  <arg choice=req>secondary_remote</arg>
 </cmdsynopsis>
 <cmdsynopsis>
  <command>drbdsetup</command>
  <arg choice=req><replaceable>device</replaceable></arg>
  <arg choice=req>replicate</arg>
 </cmdsynopsis>
 <cmdsynopsis>
  <command>drbdsetup</command>
  <arg choice=req><replaceable>device</replaceable></arg>
  <arg choice=req>wait_connect</arg>
  <arg>-t<arg choice=req><replaceable>connect_timeout</replaceable></arg></arg>
 </cmdsynopsis>
 <cmdsynopsis>
  <command>drbdsetup</command>
  <arg choice=req><replaceable>device</replaceable></arg>
  <arg choice=req>wait_sync</arg>
  <arg>-t<arg choice=req><replaceable>connect_timeout</replaceable></arg></arg>
 </cmdsynopsis>
 <cmdsynopsis>
  <command>drbdsetup</command>
  <arg choice=req><replaceable>device</replaceable></arg>
  <arg choice=req>show</arg>
 </cmdsynopsis>
</refsynopsisdiv>

<refsect1>
 <title>Description</title>
 <para>
drbdsetupを使って、DRBDデバイスとブロックデバイスとを関連付け、
DRBDデバイスのペアに対してそれぞれの
ブロックデバイスをミラーリングするように設定し、
動作中のDRBDデバイスの環境設定を確認することができます。
 </para>
</refsect1>

<refsect1>
<title>Note</title>
<para>
drbdsetupはDRBDのローレベルな設定ツールです。デバイスドライバと通信
するためにdrbd、datadisk等のスクリプトが使用します。
</para>
</refsect1>

<refsect1>
<title>Commands</title>
<para>
各サブコマンドにはそれぞれ引数を必要とするものがあります。全ての値にはデフォルトの単位が
割り当てられ、K、M、Gで指定できます。これらの単位は一般的な方法(例:K=2の10乗)で定義されています。
</para>

<refsect2>
<title>disk</title>
<para>
データブロックを保存するために <replaceable>device</replaceable> を
 <replaceable>lower_device</replaceable> に関連付けます。

<replaceable>device</replaceable> は、<option>-d</option> (または <option>--disk-size</option>)
オプションをつけて実行すると、すぐに使用可能な状態になります。

<replaceable>device</replaceable> のサイズを指定しない場合は、<option>net</option> コマンドで
相手デバイスとの接続に成功したときに、使用可能な状態になります。
</para>

<variablelist>
 <varlistentry>
  <term><option>-d</option>,
   <option>--disk-size <replaceable>size</replaceable></option></term>
  <listitem><para>
接続する前にデバイスを使用する必要がある場合、このオプションを使ってDRBDデバイスの
 <replaceable>size</replaceable> をドライバに伝えます。デフォルトの単位はKBです。
  </para></listitem>
 </varlistentry>
 <varlistentry>
  <term><option>-p</option>,
   <option>--do-panic</option></term>
  <listitem><para>
<replaceable>lower_device</replaceable> のドライバがDRBDにエラーを報告した場合、DRBDは
デフォルトでそのエラーをOSの上位レイヤに伝えます。
<option>-p</option> または <option>--do-panic</option> オプションで、DRBDがカーネルパニックを
引き起こすよう指定することができます。
  </para></listitem>
 </varlistentry>
</variablelist>
</refsect2>
<refsect2>
<title>net</title>
<para>
<replaceable>device</replaceable> を、<replaceable>local_addr:port</replaceable> 
上で入ってくる接続をリッスンし、<replaceable>remote_addr:port</replaceable> 
に対して接続を開始するように設定します。
<replaceable>port</replaceable> を省略した場合、デフォルトは7788です。
TCP/IPリンク上では、指定の <replaceable>protocol</replaceable> が使われます。
有効なプロトコル指定は A、B、C です。
</para>
<variablelist>
 <varlistentry>
  <term><option>-r</option>,
   <option>--sync-rate <replaceable>rate</replaceable></option></term>
  <listitem><para>
DRBD上のアプリケーションがスムーズに動作するように、バックグラウンド同期に使う帯域を制限することができます。
デフォルトは 250 KB/秒で、デフォルトの単位は KB です。 
  </para></listitem>
 </varlistentry>
 <varlistentry>
  <term><option>-c</option>,
   <option>--connect-int <replaceable>time</replaceable></option></term>
  <listitem><para>
リモートのDRBDデバイスにすぐに接続することが不可能な場合、DRBDは接続試行をし続けます。
このオプションで、2回の試行間隔を設定できます。デフォルト値は10秒で、単位は秒です。
  </para></listitem>
 </varlistentry>
 <varlistentry>
  <term><option>-k</option>,
   <option>--skip-sync </option></term>
  <listitem><para>
再同期プロセスが自動で開始しないようにします。この再同期プロセスは、2つのDRBDデバイスが接続したら
すぐに開始します。
  </para></listitem>
 </varlistentry>
 <varlistentry>
  <term><option>-i</option>,
   <option>--ping-int <replaceable>time</replaceable></option></term>
  <listitem><para>
DRBDデバイス間のTCP/IP接続が <replaceable>time</replaceable> 秒
を超えてアイドル状態になった場合、DRBDは相手が稼動しているかを確認するために
キープアライブパケットを生成します。デフォルト値は10秒です。
  </para></listitem>
 </varlistentry>
 <varlistentry>
  <term><option>-t</option>,
   <option>--timeout <replaceable>val</replaceable></option></term>
  <listitem><para>
相手ノードが、<replaceable>val</replaceable>/10 秒以内に
期待された応答パケットを送信できなかった場合、相手ノードは
ダウンしたと認識され、TCP/IP接続が切断されます。デフォルト値は 60 = 6秒 です。

  </para></listitem>
 </varlistentry>
 <varlistentry>
  <term><option>-s</option>,
   <option>--tl-size <replaceable>size</replaceable></option></term>
  <listitem><para>
ドライバは循環データ構造を使用して送信済みデータブロックを追跡します。
プロトコル A を非常に遅いネットワークで使用している場合、このデータ構造のサイズを
大きくする必要があります。
この場合、ドライバは transfer-log is too small (転送ログが小さすぎます) というメッセージを
syslogに出力します。デフォルトの <replaceable>size</replaceable> は 256 エントリです。
  </para></listitem>
 </varlistentry>
</variablelist>
</refsect2>
<refsect2>
<title>primary</title>
<para>
<replaceable>device</replaceable> をプライマリ状態にします。
これは、アプリケーション(例:ファイルシステム)が読み書きアクセスのために
 <replaceable>device</replaceable> をオープンすることを意味します。
プライマリ状態において <replaceable>device</replaceable> に書き込まれた
データは、セカンダリ状態のデバイスにミラーリングされます。
</para>
<para>
もし接続された両方のDRBDデバイスをプライマリ状態に設定した場合、その接続はただちに切断されます。
</para>
</refsect2>
<refsect2>
<title>secondary</title>
<para>
<replaceable>device</replaceable> をセカンダリ状態にします。
この操作は、書き込みアクセスのためにデバイスをオープンしているアプリケーション
(あるいはファイルシステム)が1つでもあると失敗します。
</para>
<para>
しかしながら、接続された2つのDRBDデバイスが両方ともセカンダリ状態になることは可能です。
</para>
</refsect2>
<refsect2>
<title>secondary_remote</title>
<para>
相手の <replaceable>device</replaceable> をセカンダリ状態に設定するよう試行します。
このコマンドは相手と通信できている場合に限り成功します。ただし、相手デバイスが状態を
変更できたかどうかを知ることはできません。
</para>
</refsect2>
<refsect2>
<title>replicate</title>
<para>
接続されたDRBDデバイスのペアを完全同期状態に強制移行します。これは、
プライマリ状態のデバイスにある全てのデータブロックが、セカンダリ状態のデバイスにコピーされる
ことを意味します。
</para>
<para>
このコマンドは <replaceable>device</replaceable> が接続されたデバイスのペアの1つではない場合、
あるいは両方のデバイスがセカンダリ状態にある場合、失敗します。
</para>
</refsect2>
<refsect2>
<title>wait_connect</title>
<para>
<replaceable>device</replaceable> が相手デバイスと通信可能になるとすぐに戻ってきます。
</para>
<variablelist>
 <varlistentry>
  <term><option>-t</option>,
   <option>--time <replaceable>connect_timeout</replaceable></option></term>
  <listitem><para>
このコマンドは <replaceable>device</replaceable> が <replaceable>connect_timeout</replaceable> 秒
間、相手と通信できなかった場合に失敗します。
デフォルト値は 0 で、タイムアウト機能は無効です。
  </para></listitem>
 </varlistentry>
</variablelist>
</refsect2>
<refsect2>
<title>wait_sync</title>
<para>
<replaceable>device</replaceable> がすべての同期状態を完了するとすぐに戻り、接続状態に
なります。
</para>
<variablelist>
 <varlistentry>
  <term><option>-t</option>,
   <option>--time <replaceable>connect_timeout</replaceable></option></term>
  <listitem><para>
このコマンドは、<replaceable>device</replaceable> が <replaceable>connect_timeout</replaceable> 
秒間、非接続状態を続けた場合に失敗します。
デフォルトは 8 秒です。0 秒に設定した場合、このコマンドは接続を永久に待機します。 
  </para></listitem>
 </varlistentry>
</variablelist>
</refsect2>
<refsect2>
<title>disconnect</title>
<para>
<option>net</option> コマンドで設定した情報を <replaceable>device</replaceable> から
削除します。これは、 <replaceable>device</replaceable> が非接続状態に移行し、入ってくる接続を
リッスンしなくなることを意味します。
</para>
</refsect2>
<refsect2>
<title>down</title>
<para>
<replaceable>device</replaceable> から全ての設定情報を削除し、非接続状態に強制移行します。
</para>
</refsect2>
<refsect2>
<title>show</title>
<para>
<replaceable>device</replaceable> に関する全ての利用可能な設定情報を表示します。
</para>
</refsect2>
</refsect1>
<refsect1>
<title>例</title>
<example>
<title>デバイスのペアの設定</title>
<para>この例では、<replaceable>tc1</replaceable> および <replaceable>tc2</replaceable> と
名づけたホストがクロスケーブルで接続され、それぞれ <replaceable>192.168.37.2</replaceable>
(tc1側) と<replaceable>192.168.37.3</replaceable> (tc2側)のインターフェースを持っています。
/dev/hda6 を仮想的に共有ディスクのように設定します。</para>
<para>tc2上で実行:</para>
<screen>
$ drbdsetup /dev/nb0 disk /dev/hda6
$ drbdsetup /dev/nb0 net 192.168.37.2 192.168.37.3 B
</screen>
<para>tc1上で実行:</para>
<screen>
$ drbdsetup /dev/nb0 disk /dev/hda6
$ drbdsetup /dev/nb0 net 192.168.37.3 192.168.37.2 B
$ drbdsetup /dev/nb0 primary
$ cat /proc/drbd
<computeroutput>version       : 58

0: cs:Connected st:Primary/Secondary ns:0 nr:0 dw:0 dr:0 of:0
1: cs:WFConnection st:Secondary/Unknown ns:0 nr:0 dw:0 dr:0 of:0
</computeroutput>
</screen>
<para>
/proc/drbd を見てわかることは、両デバイスが接続され、tc1上のデバイスが利用可能ということです。
</para>
<para>
これでアプリケーションを実行することができます。:
</para>
<screen>
$ mkfs -b 4096 /dev/nb0
$ mount /dev/nb0 /mnt/mountpoint
</screen>
</example>
<example>
<title>Snapshot a device to a third machine</title>
<para>この例では、<replaceable>tc1</replaceable> と <replaceable>tc2</replaceable> 
というホストが接続され、<replaceable>tc2</replaceable> が/dev/nb0デバイス上でプライマリ状態に
なっています。
リソースのスナップショットを<replaceable>tc3の/dev/hda6</replaceable>に保存します。
</para>
<para>tc3を準備する必要があります:</para>
<screen>
$ drbdsetup /dev/nb0 disk /dev/hda6
$ drbdsetup /dev/nb0 net tc3 tc2 B
</screen>
<para>tc2上で下記を実行します:</para>
<screen>
$ drbdsetup /dev/nb0 disconnect
$ drbdsetup /dev/nb0 net tc2 tc3 B --sync-rate 4M
$ #drbdsetup /dev/nb0 replicate
$ drbdsetup /dev/nb0 wait_sync
$ drbdsetup /dev/nb0 disconnect
$ drbdsetup /dev/nb0 net tc2 tc1 B
$ #drbdsetup /dev/nb0 replicate
</screen>
<para>
リリース0.5.8のDRBDのメタデータ管理方法では、ミラーリング相手の変更を検出できません。
そのため、例の中で説明しているように replicate コマンドを実行する必要があります。
</para>
<para>
ディスクのファイルシステムを矛盾のない状態にすることなしにスナップショットが取られるため、
tc3上でこれらのコマンドを実行する必要があります。:</para>
<screen>
$ drbdsetup /dev/nb0 down
$ fsck /dev/hda6
$ mount /dev/hda6 /some/mountpoint
</screen>
</example>
</refsect1>
<refsect1>
<title>Author</title>
<simpara>
    著者：Philipp Reisner <email>philipp.reisner@linbit.com</email>
</simpara>
</refsect1>
<refsect1>
<title>Reporting Bugs</title>
<simpara>
    バグが見つかったら<email>drbd-devel@lists.sourceforge.net</email>まで報告してください。
</simpara>
</refsect1>
<refsect1>
<title>Copyright</title>
<simpara>
Copyright (c) 2001 Philipp Reisner. This  is  free software; 
see the source for copying conditions.  There is NO warranty; 
not even for MERCHANTABILIT  or FITNESS FOR A PARTICULAR PURPOSE.
</simpara>
<simpara>
    訳：久世 宏明 Copyright (c) 2002</simpara>
</refsect1>
<refsect1>
  <title>See Also</title>
  <para>
    <citerefentry><refentrytitle>drbd.conf</refentrytitle>
    <manvolnum>5</manvolnum></citerefentry>,
    <citerefentry><refentrytitle>drbd</refentrytitle>
    <manvolnum>8</manvolnum></citerefentry>,
    <citerefentry><refentrytitle>datadisk</refentrytitle>
    <manvolnum>8</manvolnum></citerefentry>
  </para>
</refsect1>
</refentry>
