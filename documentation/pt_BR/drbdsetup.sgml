<!DOCTYPE RefEntry PUBLIC "-//Davenport//DTD DocBook V3.0//EN">
<refentry>
  <docinfo><date>26 Sep 2001</date></docinfo>

  <refmeta>
    <refentrytitle>drbdsetup</refentrytitle>
    <manvolnum>8</manvolnum>
  </refmeta>
  
  <refnamediv>
    <refname>drbdsetup</refname>
    <refpurpose>Ferramenta de configuração do DRBD</refpurpose>
  </refnamediv>

  <refsynopsisdiv>
    <cmdsynopsis>
      <command>drbdsetup</command>
      <arg choice=req><replaceable>dispositivo</replaceable></arg>
      <arg choice=req>disk</arg>
      <arg choice=req><replaceable>dispositivo_armazenamento</replaceable></arg>
      <arg>-d<arg choice=req><replaceable>tamanho</replaceable></arg></arg>
      <arg>-p</arg>
    </cmdsynopsis>
    <cmdsynopsis>
      <command>drbdsetup</command>
      <arg choice=req><replaceable>dispositivo</replaceable></arg>
      <arg choice=req>net</arg>
      <arg choice=req><replaceable>endereço_local</replaceable></arg>
      <arg><replaceable>:porta</replaceable></arg>
      <arg choice=req><replaceable>endereço_remoto</replaceable></arg>
      <arg><replaceable>:porta</replaceable></arg>
      <arg choice=req><replaceable>protocolo</replaceable></arg>
      <arg>-r<arg choice=req><replaceable>taxa</replaceable></arg></arg>
      <arg>-s<arg choice=req><replaceable>tamanho</replaceable></arg></arg>
      <arg>-c<arg choice=req><replaceable>tempo</replaceable></arg></arg>
      <arg>-i<arg choice=req><replaceable>tempo</replaceable></arg></arg>
      <arg>-k</arg>
    </cmdsynopsis>
 <cmdsynopsis>
      <command>drbdsetup</command>
      <arg choice=req><replaceable>dispositivo</replaceable></arg>
      <arg choice=req>disconnect</arg>
    </cmdsynopsis>
    <cmdsynopsis>
      <command>drbdsetup</command>
      <arg choice=req><replaceable>dispositivo</replaceable></arg>
      <arg choice=req>down</arg>
    </cmdsynopsis>
    <cmdsynopsis>
      <command>drbdsetup</command>
      <arg choice=req><replaceable>dispositivo</replaceable></arg>
      <arg choice=req>primary</arg>
    </cmdsynopsis>
    <cmdsynopsis>
      <command>drbdsetup</command>
      <arg choice=req><replaceable>dispositivo</replaceable></arg>
      <arg choice=req>secondary</arg>
    </cmdsynopsis>
    <cmdsynopsis>
      <command>drbdsetup</command>
      <arg choice=req><replaceable>dispositivo</replaceable></arg>
      <arg choice=req>secondary_remote</arg>
    </cmdsynopsis>
    <cmdsynopsis>
      <command>drbdsetup</command>
      <arg choice=req><replaceable>dispositivo</replaceable></arg>
      <arg choice=req>replicate</arg>
    </cmdsynopsis>
    <cmdsynopsis>
      <command>drbdsetup</command>
      <arg choice=req><replaceable>dispositivo</replaceable></arg>
      <arg choice=req>wait_connect</arg>
      <arg>-t<arg choice=req><replaceable>tempo_limite_conexão</replaceable></arg></arg>
    </cmdsynopsis>
    <cmdsynopsis>
      <command>drbdsetup</command>
      <arg choice=req><replaceable>dispositivo</replaceable></arg>
      <arg choice=req>wait_sync</arg>
      <arg>-t<arg choice=req><replaceable>tempo_limite_conexão</replaceable></arg></arg>
    </cmdsynopsis>
    <cmdsynopsis>
      <command>drbdsetup</command>
      <arg choice=req><replaceable>dispositivo</replaceable></arg>
      <arg choice=req>show</arg>
    </cmdsynopsis>
  </refsynopsisdiv>
  
  <refsect1>
    <title>Descrição</title>
    <para>
      drbdsetup é usado para ligar um dispositivo drbd com seu dispositivo
      de armazenamento, para espelhar um par de dispositivos drbd e
      para inspecionar o estado de disposistivos drbd.
    </para>
  </refsect1>
  
  <refsect1>
    <title>Observação</title>
    <para>
      drbdsetup é usado como uma ferramenta de baixo nível. Ele é
      usado pelos scripts drbd, datadisk e drbdc para comunicar-se
      com o driver dos disposistivos.
    </para>
  </refsect1>
  
  <refsect1>
    <title>Comandos</title>
    <para>
      Cada sub-comando requer diferentes argumentos e pode receber
      um diferente conjunto de opções. Todos valores possuem unidades
      padrões que podem ser alteradas ao especificar-se K, M ou G.
      As unidades são definidas da maneira convencional (exemplo: K = 2^10).
    </para>
    
    <refsect2>
      <title>disk</title>
      <para>
	Associa <replaceable>dispositivo</replaceable> com
	<replaceable>dispositivo_armazenamento</replaceable>.
	O <replaceable>dispositivo</replaceable> apenas é tido como
	pronto para uso quando usado com a opção  <option>-d</option>
	(ou <option>--disk-size</option>).
	Quando não for especificado o tamanho do disco, o 
	<replaceable>dispositivo</replaceable> só será tratado como
	pronto para uso quando conectar-se a seu parceiro através do
	sub-comando <option>net</option>.
      </para>
      
      <variablelist>
	<varlistentry>
	  <term><option>-d</option>,
	    <option>--disk-size <replaceable>tamanho</replaceable></option></term>
	  <listitem><para>
	      Se você precisar usar os dispositivos antes de conectá-los, use esta
	      opção para passar o <replaceable>tamanho</replaceable> do disco (ou
	      partição) ao driver. Unidade padrão é KB.
	    </para></listitem>
	</varlistentry>
	<varlistentry>
	  <term><option>-p</option>,
	    <option>--do-panic</option></term>
	  <listitem><para>
	      Se o driver do <replaceable>dispositivo_armazenamento</replaceable> enviar
	      um erro ao drbd, drbd normalmente passa este erro as camadas mais superiore
	      do sistema operacional. Com a opção <option>-p</option> ou
	      <option>--do-panic</option> você pode solicitar que drbd emita um 
	      <quote>kernel panic</quote> no caso de erros.
	    </para></listitem>
	</varlistentry>
      </variablelist>
    </refsect2>
    <refsect2>
      <title>net</title>
      <para>
	Configura o <replaceable>dispositivo</replaceable> para esperar por conexões
	em <replaceable>endereço_local:porta</replaceable> e tentar conectar em
	<replaceable>endereço_remoto:porta</replaceable>. Caso <replaceable>porta</replaceable>
	não seja especificada, a porta de número 7788 é usada como padrão.
	Em conjunto com a conexão TCP/IP o <replaceable>protocolo</replaceable>
	especificado é usado. Protocolos válidos são A, B ou C.
      </para>
      <variablelist>
	<varlistentry>
	  <term><option>-r</option>,
	    <option>--sync-rate <replaceable>taxa</replaceable></option></term>
	  <listitem><para>
	      Para assegurar uma operação tranqüila da aplicação funcionando com drbd,
	      é possível limitar a banda usada por operações de sincronização executadas
	      em segundo plano. O padrão é 250 KB/sec, a unidade padrão é KB.
	    </para></listitem>
	</varlistentry>
	<varlistentry>
	  <term><option>-c</option>,
	    <option>--connect-int <replaceable>tempo</replaceable></option></term>
	  <listitem><para>
	      Caso não seja possível conectar ao disposistivo drbd imediatamente,
	      drbd continua tentando conectar, com intervalos de <replaceable>tempo</replaceable>
	      segundos. O padrão é 10 segundos, a unidade padrão é 1 segundo.
	    </para></listitem>
	</varlistentry>
	<varlistentry>
	  <term><option>-k</option>,
	    <option>--skip-sync </option></term>
	  <listitem><para>
	      Essa opção inibe o início automático do processo de resincronização,
	      que é disparado sempre que dois dispositivos drbd são conectados.
	    </para></listitem>
	</varlistentry>
	<varlistentry>
	  <term><option>-i</option>,
	    <option>--ping-int <replaceable>tempo</replaceable></option></term>
	  <listitem><para>
	      Se a conexão TCP/IP entre o par de dispositivos drbd não puder ser usado
	      por mais de <replaceable>tempo</replaceable> segundos, drbd gerará um pacote
	      <quote>keep-alive</quote> para checar se seu parceiro ainda está vivo.
	      O padrão é 10 segundos.
	    </para></listitem>
	</varlistentry>
	<varlistentry>
	  <term><option>-t</option>,
	    <option>--timeout <replaceable>valor</replaceable></option></term>
	  <listitem><para>
	      Se uma máquina não enviar um pacote (esperado pela outra) dentro
	      de <replaceable>valor</replaceable> décimos de segundo, a outra
	      máquina é considerada morta e a conexão TCP/IP é abandonada.
	      O valor padrão é 60 = 6 segundos.
	    </para></listitem>
	</varlistentry>
	<varlistentry>
	  <term><option>-s</option>,
	    <option>--tl-size <replaceable>tamanho</replaceable></option></term>
	  <listitem><para>
	      O driver usa em estrura de dados cíclica para controlar os blocos
	      de dados enviados. Quando o protocolo A estiver sendo usado, e
	      a rede tiver alto tráfego, pode ser necessário aumentar esse valor.
	      Se este for o caso, o driver escreverá mensagens no syslog dizendo
	      que o <quote>transfer-log</quote> é pequeno demais. O valor padrão
	      de <replaceable>tamanho</replaceable> é 256 entradas.
	    </para></listitem>
	</varlistentry>
      </variablelist>
    </refsect2>
    <refsect2>
      <title>primary</title>
      <para>
	Passa o <replaceable>dispositivo</replaceable> para estado primário, isto
	significa que aplicações (como um sistema de arquivos) podem abrir o
	<replaceable>dispositivo</replaceable> para leitura e gravação. Data escrita
	neste <replaceable>dispositivo</replaceable> em modo primário é espelhado
	para o dispositivo em modo secundário.
      </para>
      <para>
	Se você tentar colocar ambos dispositivos de um par em modo primário,
	eles irão se desconectar imediatamente.
      </para>
    </refsect2>
    <refsect2>
      <title>secondary</title>
      <para>
	Passa o <replaceable>dispositivo</replaceable> para modo secundário, esta
	operação falha se houver pelo menos uma aplicação (ou sistema de arquivos)
	com o <replaceable>disposistivo</replaceable> aberto para gravação.
      </para>
      <para>
	É possível, entretanto, que ambos dispositivos de um par de dispositivos drbd
	estejam em modo secundário.
      </para>
    </refsect2>
    <refsect2>
      <title>secondary_remote</title>
      <para>
	Tenta passar o parceiro do <replaceable>dispositivo</replaceable> para modo
	secundário. Este comando retornará com sucesso desde que seja possível comunicar-se
	com o parceiro. Seu valor de retorno não indica se o dispositivo parceiro pôde
	mudar de modo.
      </para>
    </refsect2>
    <refsect2>
      <title>replicate</title>
      <para>
	Este sub-comando ordena a um par de dispositivos drbd que entrem em modo SyncAll,
	que significa que todos os blocos do dispositivo em estado primário são copiados
	para o dispositivo em modo secundário.
      </para>
      <para>
	Este comando falhará se o <replaceable>dispositivo</replaceable> não for parte
	de uma de dispositivos conectados ou se ambos os dispositivos estiverem em modo
	secundário.
     </para>
    </refsect2>
    <refsect2>
      <title>wait_connect</title>
      <para>
	Retorna logo que o <replaceable>dispositivo</replaceable> possa comunicar
	com seu dispositivo parceiro.
      </para>
      <variablelist>
	<varlistentry>
	  <term><option>-t</option>,
	    <option>--time <replaceable>tempo_limite_conexão</replaceable></option></term>
	  <listitem><para>
	      Este comando falhará se o <replaceable>dispositivo</replaceable> não puder se
	      comunicar com seu parceiro por <replaceable>tempo_limite_conexão</replaceable>
	      segundos. O valor padrão é 0 que desabilita este mecanismo.
	    </para></listitem>
	</varlistentry>
      </variablelist>
    </refsect2>
    <refsect2>
      <title>wait_sync</title>
      <para>
	Retorno logo que o <replaceable>dispositivo</replaceable> sai de qualquer modo de
	sincronização e volta para modo conectado.
      </para>
      <variablelist>
	<varlistentry>
	  <term><option>-t</option>,
	    <option>--time <replaceable>tempo_limite_conexão</replaceable></option></term>
	  <listitem><para>
	      Este comando falhará se o <replaceable>dispositivo</replaceable> ficar
	      por <replaceable>tempo_limite_conexão</replaceable> segundos em modo
	      desconectado. O valor padrão é 8 segundos. Se for dado valor 0, o
	      comando esperá por uma conexão infinitamente.
	    </para></listitem>
	</varlistentry>
      </variablelist>
    </refsect2>
    <refsect2>
      <title>disconnect</title>
      <para>
	Remove os parâmetros estabelecids pelo sub-comando <option>net</option>
	do <replaceable>dispositivo</replaceable>. Isto significa que 
	o <replaceable>dispositivo</replaceable> muda para modo desconectado
	e não esperará mais por conexões.
      </para>
    </refsect2>
    <refsect2>
      <title>down</title>
      <para>
	Remove toda configuração do <replaceable>dispositivo</replaceable>
	e força-o mudar para modo desconfigurado.
      </para>
    </refsect2>
    <refsect2>
      <title>show</title>
      <para>
	Exibe toda informação disponível sobre a configuração do <replaceable>dispositivo</replaceable>.
      </para>
    </refsect2>
  </refsect1>
  <refsect1>
    <title>Exemplos</title>
    <example>
      <title>Preparando e conectando um par de dispositivos</title>
      <para>Neste exemplo, as máquinas <replaceable>tc1</replaceable>
	e <replaceable>tc2</replaceable>, estão conectadas diretamente por
	um cabo através das interfaces <replaceable>192.168.37.2</replaceable>
	(em tc1) and <replaceable>192.168.37.3</replaceable> (em tc2).
	Iremos transformar /dev/hda6 em um disco compartilhado.</para>
      <para>No tc2 precisamos fazer isso:</para>
      <screen>
	$ drbdsetup /dev/nb0 disk /dev/hda6
	$ drbdsetup /dev/nb0 net 192.168.37.2 192.168.37.3 B
      </screen>
      <para>E no tc1 fazemos assim:</para>
      <screen>
	$ drbdsetup /dev/nb0 disk /dev/hda6
	$ drbdsetup /dev/nb0 net 192.168.37.3 192.168.37.2 B
	$ drbdsetup /dev/nb0 primary
	$ cat /proc/drbd
	<computeroutput>version       : 58
	  
	  0: cs:Connected st:Primary/Secondary ns:0 nr:0 dw:0 dr:0 of:0
	  1: cs:WFConnection st:Secondary/Unknown ns:0 nr:0 dw:0 dr:0 of:0
	</computeroutput>
      </screen>
      <para>
	Com base em /proc/drbd podemos ver que nosso par de dispositivos
	está conectado e que o dispositivo está pronto para uso em tc1.</para>
      <para>Podemos agora rodar nossa aplicação em cima deste dispositivo:</para>
      <screen>
	$ mkfs -b 4096 /dev/nb0
	$ mount /dev/nb0 /mnt/mountpoint
</screen>
    </example>
    <example>
      <title>Espelhar um dispositivo para uma terceira máquina</title>
      <para>Neste exemplo, as máquinas <replaceable>tc1</replaceable>
	e <replaceable>tc2</replaceable>, estão conectadas e tc2 tem
	/dev/nb0 em modo primário. O recurso deve ser espelhado para
	<replaceable>tc3's /dev/hda6</replaceable>.</para>
      <para>Preparamos então tc3:</para>
      <screen>
	$ drbdsetup /dev/nb0 disk /dev/hda6
	$ drbdsetup /dev/nb0 net tc3 tc2 B
      </screen>
      <para>No tc2 executamos:</para>
<screen>
	$ drbdsetup /dev/nb0 disconnect
	$ drbdsetup /dev/nb0 net tc2 tac3 B --sync-rate 4M
	$ #drbdsetup /dev/nb0 replicate
	$ drbdsetup /dev/nb0 wait_sync
	$ drbdsetup /dev/nb0 disconnect
	$ drbdsetup /dev/nb0 net tc2 tc1 B
	$ #drbdsetup /dev/nb0 replicate
      </screen>
      <para>Na versão 0.5.8, o gerenciamento de meta-data do drbd não
	pode detectar mudanças em parceiros. Por isso você precisa
	usar o comando para replicar como mostrado acima.</para>
      <para>Uma vez que o espelhamento foi feito sem trazer o sistema de
	arquivos para um estado consistente, precisamos executar em tc3:</para>
      <screen>
	$ drbdsetup /dev/nb0 down
	$ fsck /dev/hda6
	$ mount /dev/hda6 /some/mountpint
      </screen>
    </example>
  </refsect1>
  <refsect1>
    <title>Autor</title>
    <simpara>Escrito por Philipp Reisner <email>philipp.reisner@linbit.com</email></simpara>
    <simpara>Traduzido por Cleber Rodrigues <email>cleberrrjr@bol.com.br</email></simpara>
  </refsect1>
  <refsect1>
    <title>Relatando Bugs</title>
    <simpara>Envie relatórios de bugs para <email>drbd-devel@lists.sourceforge.net</email>.</simpara>
  </refsect1>
<refsect1>
    <title>Direitos Autorais</title>
    <simpara>
      Copyright (c) 2001 Philipp Reisner. This  is  free software; 
      see the source for copying conditions.  There is NO warranty; 
      not even for MERCHANTABILIT  or FITNESS FOR A PARTICULAR PURPOSE.
    </simpara>
  </refsect1>
<refsect1>
  <title>Veja também</title>
  <para>
    <citerefentry><refentrytitle>drbd.conf</refentrytitle>
    <manvolnum>5</manvolnum></citerefentry>,
    <citerefentry><refentrytitle>drbd</refentrytitle>
    <manvolnum>8</manvolnum></citerefentry>,
    <citerefentry><refentrytitle>datadisk</refentrytitle>
    <manvolnum>8</manvolnum></citerefentry>
  </para>
</refsect1>
</refentry>
