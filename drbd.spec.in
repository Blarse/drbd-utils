# "uname -r" output of the kernel to build for, the running one
# if none was specified with "--define 'kernelversion <uname -r>'"
# PLEASE: provide both (correctly) or none!!
%{!?kernelversion: %{expand: %%define kernelversion %(uname -r)}}
%{!?kdir: %{expand: %%define kdir /lib/modules/%(uname -r)/build}}

# encode - to _ to be able to include that in a package name or release "number"
%global krelver  %(echo %{kernelversion} | tr -s '-' '_')

# Conditionals -- invoke "rpmbuild --without <feature>" to disable
# specific features
# note: conditionals may not contain "-" nor "_", hence "bashcompletion"
%bcond_without utils
%bcond_with km
%bcond_without xen
%bcond_without udev
%bcond_without pacemaker
%bcond_with rgmanager
%bcond_without heartbeat
%bcond_without bashcompletion

Name: @PACKAGE_TARNAME@
Summary: DRBD driver for Linux
Version: @PACKAGE_VERSION@
Release: 8@RPM_DIST_TAG@
Source: http://oss.linbit.com/%{name}/8.3/%{name}-%{version}.tar.gz
License: GPLv2+
ExclusiveOS: linux
Group: System Environment/Kernel
URL: http://www.drbd.org/
BuildRoot: %(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)
%if %{with utils}
BuildRequires: flex, gcc
%endif
%if %{with km}
BuildRequires: gcc, @RPM_BUILDREQ_KM@
%endif
%if %{with udev}
BuildRequires: udev
%endif
Requires: %{name}-utils = %{version}
%if %{with xen}
Requires: %{name}-xen = %{version}
%endif
%if %{with pacemaker}
Requires: %{name}-pacemaker = %{version}
%endif
%if %{with rgmanager}
Requires: %{name}-rgmanager = %{version}
%endif
%if %{with heartbeat}
Requires: %{name}-heartbeat = %{version}
%endif
%if %{with bashcompletion}
Requires: %{name}-bash-completion = %{version}
%endif

%description
DRBD mirrors a block device over the network to another machine.
Think of it as networked raid 1. It is a building block for
setting up high availability (HA) clusters.

This is a virtual package, installing the full DRBD userland suite.

Authors:
--------
    Philipp Reisner <philipp.reisner@linbit.com>
    Lars Ellenberg  <lars.ellenberg@linbit.com>

Please report bugs to @PACKAGE_BUGREPORT@.

# Just a few docs go into the "drbd" package. Everything else is part
# of one of the drbd-* packages.
%files
%defattr(-,root,root)
%doc COPYING
%doc ChangeLog
%doc README

%if %{with utils}
%package utils
Summary: Management utilities for DRBD
Group: System Environment/Kernel

%description utils
DRBD mirrors a block device over the network to another machine.
Think of it as networked raid 1. It is a building block for
setting up high availability (HA) clusters.

This packages includes the DRBD administration tools.

%files utils
%defattr(755,root,root)
/sbin/drbdsetup
/sbin/drbdadm
/sbin/drbdmeta
%{_initrddir}/%{name}
%{_sbindir}/drbd-overview
%{_prefix}/lib/%{name}

%defattr(-,root,root)
%{_var}/lib/%{name}
%config(noreplace) %{_sysconfdir}/drbd.conf

%defattr(-,root,root)
%{_mandir}/man8/drbd.8.*
%{_mandir}/man8/drbdsetup.8.*
%{_mandir}/man8/drbdadm.8.*
%{_mandir}/man5/drbd.conf.5.*
%{_mandir}/man8/drbdmeta.8.*
%doc scripts/drbd.conf
%doc COPYING
%doc ChangeLog
%doc README
%endif # with utils

%if %{with km}
# I choose to have the kernelversion as part of the package name!
# drbd is prepended...
%package km-%{krelver}
Summary: Kernel driver for DRBD.
Group: System Environment/Kernel
Conflicts: @RPM_CONFLICTS_KM@
# always require a suitable userland and depmod.
Requires: %{name}-utils = %{version}, /sbin/depmod
# to be able to override from build scripts which flavor of kernel we are building against.
Requires: %{expand: %(echo ${DRBD_KMOD_REQUIRES:-kernel})}
# TODO: break up this generic .spec file into per distribution ones,
# and use the distribution specific naming and build conventions for kernel modules.

%description km-%{krelver}
This module is the kernel-dependent driver for DRBD.  This is split out so
that multiple kernel driver versions can be installed, one for each
installed kernel.

%files km-%{krelver}
%defattr(-,root,root)
/lib/modules/%{kernelversion}/
%doc COPYING
%doc ChangeLog
%doc drbd/k-config-%{kernelversion}.gz
%endif  # with km

%if %{with xen}
%package xen
Summary: Xen block device management script for DRBD
Group: System Environment/Kernel
Requires: %{name}-utils = %{version}, xen
@RPM_SUBPACKAGE_NOARCH@

%description xen
This package contains a Xen block device helper script for DRBD, capable of
promoting and demoting DRBD resources as necessary.

%files xen
%defattr(755,root,root)
%{_sysconfdir}/xen/scripts/block-drbd

%defattr(-,root,root)
%doc COPYING
%endif # with xen

%if %{with udev}
%package udev
Summary: udev integration scripts for DRBD
Group: System Environment/Kernel
Requires: %{name}-utils = %{version}, udev
@RPM_SUBPACKAGE_NOARCH@

%description udev
This package contains udev helper scripts for DRBD, managing symlinks to
DRBD devices in /dev/drbd/by-res and /dev/drbd/by-disk.

%files udev
%defattr(-,root,root)
%config %{_sysconfdir}/udev/rules.d/65-drbd.rules*
%doc COPYING
%endif # with udev

%if %{with pacemaker}
%package pacemaker
Summary: Pacemaker resource agent for DRBD
Group: System Environment/Base
Requires: %{name}-utils = %{version}, pacemaker
@RPM_SUBPACKAGE_NOARCH@

%description pacemaker
This package contains the master/slave DRBD resource agent for the
Pacemaker High Availability cluster manager.

%files pacemaker
%defattr(755,root,root)
%{_prefix}/lib/%{name}/crm-fence-peer.sh
%{_prefix}/lib/%{name}/crm-unfence-peer.sh
%{_prefix}/lib/ocf/resource.d/linbit/drbd

%defattr(-,root,root)
%doc COPYING
%endif # with pacemaker

%if %{with rgmanager}
%package rgmanager
Summary: Red Hat Cluster Suite agent for DRBD
Group: System Environment/Base
Requires: %{name}-utils = %{version}, rgmanager < 3
Conflicts: resource-agents >= 3
@RPM_SUBPACKAGE_NOARCH@

%description rgmanager
This package contains the DRBD resource agent for the Red Hat Cluster Suite
resource manager.

As of Red Hat Cluster Suite 3.0.1, the DRBD resource agent is included
in the Cluster distribution.

%files rgmanager
%defattr(755,root,root)
%{_datadir}/cluster/drbd.sh

%defattr(-,root,root)
%{_datadir}/cluster/drbd.metadata
%doc COPYING
%endif # with rgmanager

%if %{with heartbeat}
%package heartbeat
Summary: Heartbeat resource agent for DRBD
Group: System Environment/Base
Requires: %{name}-utils = %{version}, heartbeat
@RPM_SUBPACKAGE_NOARCH@

%description heartbeat
This package contains the DRBD resource agents for the Heartbeat cluster
resource manager (in v1 compatibility mode).

%files heartbeat
%defattr(755,root,root)
%{_sysconfdir}/ha.d/resource.d/drbddisk
%{_sysconfdir}/ha.d/resource.d/drbdupper

%defattr(-,root,root)
%{_mandir}/man8/drbddisk.8.*
%doc COPYING
%endif # with heartbeat

%if %{with bashcompletion}
%package bash-completion
Summary: Programmable bash completion support for drbdadm
Group: System Environment/Base
Requires: %{name}-utils = %{version}, bash-completion
@RPM_SUBPACKAGE_NOARCH@

%description bash-completion
This package contains programmable bash completion support for the drbdadm
management utility.

%files bash-completion
%defattr(-,root,root)
%config %{_sysconfdir}/bash_completion.d/drbdadm*
%doc COPYING
%endif # with bashcompletion


%prep
%setup -q
%if %{with km}
test -d %{kdir}/.
test "$(KDIR=%{kdir} scripts/get_uts_release.sh)" = %{kernelversion}
%endif
%configure \
    %{?_without_utils} \
    %{?_with_km} \
    %{?_without_udev} \
    %{?_without_xen} \
    %{?_without_pacemaker} \
    %{?_without_heartbeat} \
    %{?_with_rgmanager} \
    %{?_without_bashcompletion}


%build
echo kernelversion=%{kernelversion}
echo kversion=%{kversion}
echo krelver=%{krelver}
make %{_smp_mflags} tools doc
%if %{with km}
make %{_smp_mflags} module KDIR=%{kdir}
%endif

%install
rm -rf %{buildroot}
make install DESTDIR=%{buildroot}
%if %{with km}
cd drbd
mv .kernel.config.gz k-config-%{kernelversion}.gz
%endif
%if %{with utils}
#
# We only want to install a hint to the example conf
#
cat <<___ > %{buildroot}%{_sysconfdir}/drbd.conf
#
# please have a a look at the example configuration file in
# %{_docdir}/%{name}-utils-%{version}/drbd.conf
#
___
%endif

%clean
rm -rf %{buildroot}

%if %{with utils}
%post utils
chkconfig --add drbd
%if %{without udev}
for i in `seq 0 15` ; do
    test -b /dev/drbd$i || mknod -m 0660 /dev/drbd$i b 147 $i;
done
%endif

%preun utils
if [ $1 -eq 0 ]; then
        %{_initrddir}/drbd stop >/dev/null 2>&1
        /sbin/chkconfig --del drbd
fi
%endif # with-utils

%if %{with km}
%preun km-%{krelver}
lsmod | grep drbd > /dev/null 2>&1
if [ $? -eq 0 ]; then
    rmmod drbd
fi

#%post -n kernel%{?ksmp}-module-drbd
%post km-%{krelver}
# hack for distribution kernel packages,
# which already contain some (probably outdated) drbd module
EXTRA_DRBD_KO=/lib/modules/%{kernelversion}/extra/drbd.ko
if test -e $EXTRA_DRBD_KO; then
    mv $EXTRA_DRBD_KO $EXTRA_DRBD_KO.orig
fi
uname -r | grep BOOT ||
/sbin/depmod -a -F /boot/System.map-%{kernelversion} %{kernelversion} >/dev/null 2>&1 || true

#%postun -n kernel%{?ksmp}-module-drbd
%postun km-%{krelver}
/sbin/depmod -a -F /boot/System.map-%{kernelversion} %{kernelversion} >/dev/null 2>&1 || true
%endif # with km

%changelog
* Wed Oct 14 2009 Florian Haas <florian@linbit.com> - 8.3.4-8@RPM_DIST_TAG@
- Packaging makeover.

* Thu Oct  6 2009 Philipp Reisner <phil@linbit.com> - 8.3.4-1
- New upstream release.

* Thu Oct  5 2009 Philipp Reisner <phil@linbit.com> - 8.3.3-1
- New upstream release.

* Fri Jul  3 2009 Philipp Reisner <phil@linbit.com> - 8.3.2-1
- New upstream release.

* Fri Mar 27 2009 Philipp Reisner <phil@linbit.com> - 8.3.1-1
- New upstream release.

* Thu Dec 18 2008 Philipp Reisner <phil@linbit.com> - 8.3.0-1
- New upstream release.

* Thu Nov 12 2008 Philipp Reisner <phil@linbit.com> - 8.2.7-1
- New upstream release.

* Fri May 30 2008 Philipp Reisner <phil@linbit.com> - 8.2.6-1
- New upstream release.

* Tue Feb 12 2008 Philipp Reisner <phil@linbit.com> - 8.2.5-1
- New upstream release.

* Fri Jan 11 2008 Philipp Reisner <phil@linbit.com> - 8.2.4-1
- New upstream release.

* Wed Jan  9 2008 Philipp Reisner <phil@linbit.com> - 8.2.3-1
- New upstream release.

* Fri Nov  2 2007 Philipp Reisner <phil@linbit.com> - 8.2.1-1
- New upstream release.

* Fri Sep 28 2007 Philipp Reisner <phil@linbit.com> - 8.2.0-1
- New upstream release.

* Mon Sep  3 2007 Philipp Reisner <phil@linbit.com> - 8.0.6-1
- New upstream release.

* Fri Aug  3 2007 Philipp Reisner <phil@linbit.com> - 8.0.5-1
- New upstream release.

* Wed Jun 27 2007 Philipp Reisner <phil@linbit.com> - 8.0.4-1
- New upstream release.

* Mon May 7 2007 Philipp Reisner <phil@linbit.com> - 8.0.3-1
- New upstream release.

* Fri Apr 6 2007 Philipp Reisner <phil@linbit.com> - 8.0.2-1
- New upstream release.

* Mon Mar 3 2007 Philipp Reisner <phil@linbit.com> - 8.0.1-1
- New upstream release.

* Wed Jan 24 2007 Philipp Reisner <phil@linbit.com>  - 8.0.0-1
- New upstream release.

