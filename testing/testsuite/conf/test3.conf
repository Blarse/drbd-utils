#
# test2.conf
#
# test all implemented commands
#

node node1 {
  addr  10.25.91.10;
  port  4000;
}

node node2 {
  addr  10.25.91.11;
  port  4000;
}

defaults {
  timeout  30;
  latency  0.05;
}

seq-commands {
  cmd 'drbdadm -- DDFFC66571C5E5CB::::1 set-gi {resource}', rc 0;
  cmd 'drbdadm up {resource}', rc 0;
  expected 'cs', state 'Connected', timeout 10;
  cmd 'drbdadm primary {resource}', on node1, rc 0;
  expected 'st', on node1, state 'Primary/Secondary', timeout 2;
  sleep 2;

  #Device Mapper
  cmd 'dmsetup supend {dm_device}', rc 50;
  expected 'st', state 'Secondary/Secondary', timeout 2;
  
  cmd 'dmsetup resume {dm_device}', rc 10;
  expected 'cs', state 'Connected', timeout 10;
  expected 'st', on node1, state 'Primary/Secondary', timeout 2; 

  #DRBD-Specific
  cmd 'drbdadm secondary {resource}', on node1, rc 0;
  expected 'st', on node1, state 'Secondary/Secondary', timeout 2;
  sleep 2; 

  cmd 'drbdadm primary {resource}', on node1, rc 0;
  expected 'st', on node1, state 'Primary/Secondary', timeout 2;
  sleep 2;

  #turn of nw
  cmd 'iptables -I OUTPUT -o $config{drbd_interface} -j DROP';
  expected 'cs', state 'Disconnected', timeout 10;

  #turn on nw
  cmd 'iptables -I OUTPUT -o $config{drbd_interface} -j DROP';
  expected 'cs', state 'Connected', timeout 10;

  #stop drbd
  cmd '/etc/init.d/drbd stop';
  expected 'cs', state 'Disconnected', timeout 10;
  expected 'st', on node1, state 'Secondary/Secondary', timeout 2;

  #start drbd
  cmd '/etc/init.d/drbd restart';
  expected 'cs', state 'Connected', timeout 10;
  expected 'st', on node1, state 'Secondary/Secondary', timeout 2;

  #restart drbd
  cmd '/etc/init.d/drbd restart';
  expected 'cs', state 'Connected', timeout 10;
  expected 'st', on node1, state 'Secondary/Secondary', timeout 2;

  #mount
  cmd 'mount /dev/{drbd_device} {drbd_mountpoint}';

  #umount
  cmd 'umount /dev/{device}';
 
}
